#!/usr/bin/env node

/**
 * Module dependencies.
 */

var program = require('commander');
var pkg = require('../package');
var moment = require('moment');
var fmt = require('printf');
var ES = require('..');

// options

program
  .version(pkg.version)
  .usage('[options] [query]')
  .option('-u, --url <url>', 'elastic search url')
  .option('-i, --index <name>', 'index name')
  .option('-t, --type <name>', 'index type')
  .parse(process.argv);

// setup

var es = new ES({
  url: program.url,
  index: program.index,
  type: program.type
});

// query

var str = program.args.join(' ');
var query = es.query(str);

// output

console.log();
query.on('data', function(logs){
  logs.map(output);
});

process.on('exit', function(){
  console.log();
});

/**
 * Format output for `log`.
 */

function output(log) {
  var format = 'MMM Do YY, h:mm:ssa';
  var date = moment(log.timestamp).format(format);
  var host = log.hostname;
  var msg = log.message;
  var level = log.level;
  var type = log.type;

  var color = '32';
  if ('warn' == level) color = '33';
  if ('error' == level) color = '31';
  if ('fatal' == level) color = '31';

  console.log(fmt('  \033[90m%s\033[0m \033[36m(%s) \033[' + color + 'm%s\033[0m - %s - %s', date, host, level, type, msg));
}
